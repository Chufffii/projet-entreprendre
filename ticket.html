<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ticket - Au Fil des Pages</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="ticket" id="ticket"></div>

  <div class="ajout-conso" id="ajout-conso-section">
    <h3>Ajouter une consommation</h3>
    <input type="text" id="newConso" placeholder="ex : Jus bio, Cookie...">
    <button onclick="ajouterConso()">Ajouter</button>
    <button onclick="fermerCommande()" style="margin-top: 10px; background-color: #8b0000;">Fermer la commande</button>
  </div>

  <script>
    const prices = {
      'Goûter littéraire': 5.99,
      'Lecture fraîche': 6.99,
      'Formule Lyonnaise': 8.99
    };

    let consoListe = [];
    let formulePrix = 0;
    let startTime;
    let personnes;
    let mode;
    let formule;
    let commandeFermee = false;

    function calculateDuration(startTime) {
      const now = new Date();
      const diffMs = now - new Date(startTime);
      const minutes = Math.floor(diffMs / 60000);
      const hours = Math.floor(minutes / 60);
      const remainder = minutes % 60;
      return `${hours}h${remainder < 10 ? '0' : ''}${remainder}`;
    }

    function calculateFlexiblePrice(startTime, ratePerMinute, personnes) {
      const now = new Date();
      const diffMs = now - new Date(startTime);
      const totalMinutes = Math.ceil(diffMs / 60000);
      return (totalMinutes * ratePerMinute * personnes).toFixed(2);
    }

    function renderTicket() {
      let total = 0;
      let html = '';

      html += `<img src="logo.jpeg" class="logo" alt="Logo Au Fil des Pages">
               <h1 class="peniche-name">Au Fil des Pages</h1>`;

      const now = new Date();
      const date = now.toLocaleDateString('fr-FR');
      const hour = now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
      const ticketNumber = Math.floor(Math.random() * 9000) + 1000;

      html += `<div class="ticket-info">
                 <p><strong>Date :</strong> ${date}</p>
                 <p><strong>Heure d'entrée :</strong> ${hour}</p>
                 <p><strong>Ticket n° :</strong> ${ticketNumber}</p>
                 <p><strong>Nombre de personnes :</strong> ${personnes}</p>
                 <p><strong>Type de balade :</strong> ${mode === 'complet' ? 'Tour complet' : 'Flexible (au temps)'}</p>
               </div>`;

      if (mode === 'flexible') {
        const duration = calculateDuration(startTime);
        const price = calculateFlexiblePrice(startTime, 0.10, personnes);
        html += `<div class="temps">
                   <p><strong>Temps estimé :</strong> ${duration}</p>
                   <p><strong>Tarif balade (${personnes} pers) :</strong> ${price}€</p>
                 </div>`;
        total += parseFloat(price);
      } else {
        const forfait = 12.00 * personnes;
        html += `<div class="temps">
                   <p><strong>Tarif balade (${personnes} pers) :</strong> ${forfait.toFixed(2)}€</p>
                 </div>`;
        total += forfait;
      }

      if (formule) {
        html += `<div class="consommations"><h2>Formule ajoutée</h2><ul><li>${formule} — ${formulePrix.toFixed(2)}€</li></ul></div>`;
        total += formulePrix;
      }

      if (consoListe.length > 0) {
        html += `<div class="consommations"><h2>Consommations supplémentaires</h2><ul>`;
        consoListe.forEach(el => html += `<li>${el}</li>`);
        html += `</ul></div>`;
      }

      html += `<div class="total"><p><strong>Total estimé :</strong> ${total.toFixed(2)}€</p></div>`;
      html += `<p class="merci">Merci de votre visite et à très bientôt !</p>`;

      document.getElementById('ticket').innerHTML = html;
    }

    function ajouterConso() {
      if (commandeFermee) return;
      const conso = document.getElementById('newConso').value.trim();
      if (conso) {
        consoListe.push(conso);
        document.getElementById('newConso').value = '';
        renderTicket();
      }
    }

    function fermerCommande() {
      commandeFermee = true;
      document.getElementById('ajout-conso-section').style.display = 'none';
    }

    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      personnes = parseInt(params.get('personnes')) || 1;
      mode = params.get('mode');
      formule = decodeURIComponent(params.get('formule') || '');
      startTime = new Date().toISOString();
      formulePrix = prices[formule] || 0;

      const initialAjouts = decodeURIComponent(params.get('ajouts') || '').split(',').map(e => e.trim()).filter(Boolean);
      consoListe = [...initialAjouts];

      renderTicket();
      setInterval(() => { if (!commandeFermee) renderTicket(); }, 60000);
    }
  </script>
</body>
</html>
